<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>DarkCPU: Lateral File System (LAFS)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="large.png.bkp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">DarkCPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__lateral_fs.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Lateral File System (LAFS) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section note"><dt>Note</dt><dd>This standard has not been finalized.</dd></dl>
<h2>Relavent Code Modules</h2>
<p><a class="el" href="vfs-10c_8c.html#VirtualFileSystem">VirtualFileSystem</a></p>
<h2>Goals</h2>
<ul>
<li>Reduce read operations required by storage volume to traverse filesystem structure (i.e, lookup file contained in several layers of filesystem)</li>
<li>Remain conscious of DCPU's memory limitations and optimize process of caching with this in mind.</li>
<li>Allow smaller filesystems to operate at a highly optimal rate without sacrificing scalability</li>
</ul>
<h2>Advantages</h2>
<ul>
<li>File data can overlap directory data. Allowing for more efficient use of space.</li>
<li>All entries have a known sector allocated for them and are very predictable in nature.</li>
<li>128 entries can be cached and easily traversed with an allocation of only one 512 word buffer. Small filesystems will benifit greatly from this. Larger filesystems will need additional memory buffers to maintain look-up times. This means virtually price-less look-up times.</li>
<li>Directory structures can be isolated and easily prioritized.</li>
<li>The filesystem allows for optional metasectors, used store metadata date or user permissions.</li>
</ul>
<h2>Disadvantages</h2>
<ul>
<li>Size of a file is only accurate to a resolution of 2 words (4 bytes).</li>
<li>No support for symbolic links or more advanced filesystem structures.</li>
<li>Files cannot be easily scattered accross sectors further than 31 sectors apart. With efficient chaining, this limitation can be worked around.</li>
<li>Names limited to single byte ascii, with a length of 6 characters.</li>
<li>Max file storage per directory descriptor flat is 128 sector, 131072 bytes (65536 words)</li>
</ul>
<h1>Filesystem structure</h1>
<p>The filesystem is laid out as follows</p>
<table class="doxtable">
<tr>
<th>Name </th><th>Size (Words) </th><th>Description</th></tr>
<tr>
<td>Boot Code </td><td>512 </td><td>Contains code for the first stage bootloader. </td></tr>
<tr>
<td>Super Block </td><td>512 </td><td>Contains basic information about filesystem, and bitmaps for Allocation of entries in the Directory Descriptor Flats </td></tr>
<tr>
<td>First Directory Descriptor Flat </td><td>128*512 + 512 </td><td>First directory flat in filesystem </td></tr>
<tr>
<td>... </td><td>... </td><td>... </td></tr>
<tr>
<td>Last Directory Descriptor Flat </td><td>128*512 + 512 </td><td>Last directory flat in filesystem </td></tr>
</table>
<h1>String Flat</h1>
<p>The StringFlat is a series of 6 byte (3 word) single byte ascii strings, padded with null. A string flat is placed with a series of directory entries, and describes the name of each directory entry in parallel. I.e, entry 0 in the directory list will have a name which corresponds to the first entry of the string flat which accompanies it.</p>
<h1>Directory Descriptor Flat</h1>
<p>A directory descriptor flat is a portion on the storage consiting of a series of directory entries proceeded with a string flat, which describes, in parallel, the name of each directory entry. The size of a directory flat and its string flat must equal to the size of a single sector.</p>
<p>Solving for the system: x + 3x = 512, defines a total of 128 directory entries per a directory flat.</p>
<p>The number of directory flats present in a file system is to be determined when the volume is formatted and placed in the super block. Each directory flat is followed by 128 adjacent sectors allocated for files in the flat.</p>
<h1>Structure of Entries</h1>
<p>All entries are organized in a linked list. Each entry can describe a directory, a file, or both a directory and an extention to a file. File extentions are described later.</p>
<h2>Directory Entries</h2>
<p>Each directory entry corresponds to a name in the String Flat at an index that is the equal to the index of the entry. Further, the entry also corresponds to (i.e, owns) one of the 128 sectors which follows the File Descriptor Flat. The sector this entry owns has an index equal to the index of the entry. That is to say, the entry at index 'x', has its name described in the string flat at index 'x', and owns the sector that is 'x' sectors after the Directory Descriptor Flat. Hence the name "Lateral Filesystem."</p>
<h2>Directory Entries For Folders</h2>
<p>Directory structures (folders, subfolders etc...) are described using a linked list. When an entry of type "directory" is encountered while traversing the linked list of entries, all entries there after describe the files which belong to that folder. If, while traversing the linked list, yet another entry of type "directory" is encountered, all following entries belong to this new folder (which is contained inside of the previously encountered directory.) Immediately after the entry which marks the start of a directory is yet another which is called a skip directory.</p>
<h2>Skip Directories</h2>
<p>Skip directories behave exactly as normal directories and their next member links to the first entry in the directory, only their name field is as described below:</p>
<table class="doxtable">
<tr>
<th>Word # </th><th>Value </th><th>Meaning</th></tr>
<tr>
<td>0 </td><td>".\0" </td><td>A period followed by a null terminator. This means that this directory is a skip directory </td></tr>
<tr>
<td>1 </td><td>LastFile </td><td>Offset to the last entry of a directory. Signed offset </td></tr>
<tr>
<td>2 </td><td></td><td>Reserved </td></tr>
</table>
<p>Skip directories must be placed immediately after the start of a directory.</p>
<p>The end of a directory is reached when the last member in a directory has an index equal to the index of the skip directory plus the skip directories LastFile offset. I.e, it is the last entry in a directory if it is referenced by the skip directories LastFile offset. The last entry of a directory must link to the next entry in the filesystem.</p>
<h2>Example Directory Structure</h2>
<p>An example of this structure is illustrated below using an ascii representation of the file entries (F is file, { is new folder, and ^ is a Skip Directory Entry)</p>
<p>Pay close attention to the string table, the entry table and the sectors following the File Directory Descriptor Flat.</p>
<div class="fragment"><div class="line">String Flat (ignore the name limit, <span class="keyword">this</span> is just a demonstration):</div>
<div class="line">(<span class="stringliteral">&quot;file01&quot;</span>)</div>
<div class="line">(<span class="stringliteral">&quot;file02&quot;</span>)</div>
<div class="line">(<span class="stringliteral">&quot;fold1&quot;</span>)</div>
<div class="line">(<span class="stringliteral">&quot;.\0&quot;</span>, Offset to F5, 0)</div>
<div class="line">(<span class="stringliteral">&quot;File03 inside of fold1&quot;</span>)</div>
<div class="line">(<span class="stringliteral">&quot;File04 inside of fold1&quot;</span>) (<span class="stringliteral">&quot;File05, outside of fold1 and in root dir&quot;</span>)</div>
<div class="line">...</div>
<div class="line"></div>
<div class="line">Directory Flat</div>
<div class="line">F1 &lt;links to&gt; F2 &lt;links to&gt; { &lt;links to&gt; ^ &lt;links to&gt; F3 &lt;links to&gt; F4 &lt;links to&gt; F5 &lt;links to&gt; ...</div>
<div class="line"></div>
<div class="line">Sectors following the Flat</div>
<div class="line">Sector owned by file one</div>
<div class="line">sector owned by file two</div>
<div class="line">sector owned by folder1 (can be used as file extention)</div>
<div class="line">Sector owned by skip directory (can be used as file extention)</div>
<div class="line">Sector owned by File3</div>
<div class="line">Sector owned by file4</div>
<div class="line">Sector owned by file5</div>
<div class="line">...</div>
</div><!-- fragment --><h2>Directory Entries for Files</h2>
<p>Directory entries of type "file" work exactly as entries which describe folders in the sense that they own a sector and have a corresponding entry in the String Flat with an index equal to their own. Also, like directory entries, each file entry links to another entry to describe the next file in the system. However, the structure of a file entry differs.</p>
<p>If a file is greater than one sector (I.e it consumes more than the one sector it owns), it must be linked (with the next member) to a file extention entry. Folders and skip directories can act as both folders and file extention entries and so to locate a file extention, one can either scan for folders which have not yet been allocated as an extentions, or allocate a new entry and use it as a file extention (and if need be later, a folder as well)</p>
<h2>Long Jump Directories</h2>
<p>A long jump directory allows for the next entry to be located on a seperate directory descriptor flat. This allows you to easily isolate your directories and reference your directory structures from different descriptor flats. If a directory entry's LongJumpFlag is set, the next entry defines a relative directory descriptor flat containing the remaining members of that directory.</p>
<dl class="section warning"><dt>Warning</dt><dd>It is highly suggested that long jumps only be done with skip directories since doing so with a regular directory would force the implementation of the filesystem to traverse via a different directory descriptor flat (which may be expensive) to get to the skip directory.</dd></dl>
<h2>Meta Sectors</h2>
<p>Meta Sectors are sectors which preceed each directory descriptor flat containing metadata about the directory descriptor flat. These are not standardized and the filesystem is expected to function if the contents of these sectors are unknown. I.e, these sectors cannot contain data critical to the function of the filesystem.</p>
<dl class="section warning"><dt>Warning</dt><dd>Later revisions to LAFS will standardize metasectors.</dd></dl>
<h1>Data Structures</h1>
<h2>Boot-Stage 1 Sector</h2>
<p>The first sector of the storage media is reserved for the first-stage bootloader.</p>
<h2>Super-Block</h2>
<p>This is the second sector of the storage media and is reserved for the super block. Immediately following this sector are the Directory Descriptor Flats. The first one describing the root directory.</p>
<table class="doxtable">
<tr>
<th>Name </th><th>Size (words) </th><th>Meaning</th></tr>
<tr>
<td>LAFS Signature </td><td>2 </td><td>'lafs' little endia dword </td></tr>
<tr>
<td>Version </td><td>1 </td><td>High byte is major, low byte is minor (1.0) </td></tr>
<tr>
<td>Initial Flat </td><td>1 </td><td>Index of initial flat. </td></tr>
<tr>
<td>MetaSectors </td><td>1 </td><td>Flags describing which metasectors are present </td></tr>
<tr>
<td>reserved </td><td>3 </td><td>Reserved </td></tr>
<tr>
<td>DirDescFlatCount </td><td>1 </td><td>Number of directory descriptor flats </td></tr>
<tr>
<td>DirDescFlatBitmap </td><td>8 </td><td>Allocation bitmap for first directory descriptor flat </td></tr>
<tr>
<td>... </td><td>... </td><td>... </td></tr>
<tr>
<td>DirDescFlatBitmap </td><td>8 </td><td>Allocation bitmap for last directory descriptor flat </td></tr>
</table>
<h2>Directory Entry Structure for Directory</h2>
<table class="doxtable">
<tr>
<th>Member Name </th><th>Size </th><th>Definition</th></tr>
<tr>
<td>FileFlag </td><td>1 bit </td><td>0 = file, 1 = directory </td></tr>
<tr>
<td>ExtendedNextSign </td><td>1 bit </td><td>1 = jump back, 0 = jump forward </td></tr>
<tr>
<td>ExtendedNext </td><td>5 bit </td><td>Next entry if accessed as extention. If 0, this directory is not allocated as an extention </td></tr>
<tr>
<td>EndExtFlag </td><td>1 bit </td><td>If being accessed as an extention, set if this directory describes the last of a file's extention. </td></tr>
<tr>
<td>LongJumpFlag </td><td>1 bit </td><td>Set if NextEntry describes a directory descriptor flat (relative to the current one) </td></tr>
<tr>
<td>reserved </td><td>1 bit </td><td>reserved </td></tr>
<tr>
<td>NextEntrySign </td><td>1 bit </td><td>1 = jump back, 0 = jump forward. </td></tr>
<tr>
<td>NextEntry </td><td>5 bit </td><td>Magnitude of offset in words to next entry if not accessed as extention (direction determined by next sign bit) </td></tr>
</table>
<h2>Directory Entry Structure for a File</h2>
<table class="doxtable">
<tr>
<th>Member Name </th><th>Size </th><th>Definition</th></tr>
<tr>
<td>DirectoryFlag </td><td>1 bit </td><td>0 = file, 1 = directory </td></tr>
<tr>
<td>TrailingSizeSign </td><td>1 bit </td><td>1 = negative trailing size, 0 = positive trailing size. </td></tr>
<tr>
<td>TrailingSize </td><td>7 bit </td><td>(trailing file size - 1 in magnitude) / 2 </td></tr>
<tr>
<td>ExtentedFlag </td><td>1 bit </td><td>Set if the next entry should be accessed as an extention (i.e, the file is extended) </td></tr>
<tr>
<td>NextEntrySign </td><td>1 bit </td><td>1 = jump back, 0 = jump forward. </td></tr>
<tr>
<td>NextEntry </td><td>5 bit </td><td>Signed offset to next entry </td></tr>
</table>
<h1>Design Considerations \ Implementation Process</h1>
<h2>Offset Wrapping</h2>
<p>If the offset exceeds the bounds of a directory descriptor flat, it re-enters on the opposing boundary. That is to say if an entry at index 0 claims its next entry is at an offset of -31, and there are 128 entries per flat, the calculated next entry would be at index (127-31=96). On the opposite boundary, the same holds true. I.e if an entry at index 127 has an offset of 31, its next entry would be located at index 30.</p>
<h2>Appending to directories</h2>
<p>Directories are quick to append to, you must first adjust the next entry of the last entry of a directory (found by using the directory's jump entry) and then you need to update the jump entry.</p>
<h2>Calculating Total Size</h2>
<p>Calculating the total size explicitly may not be required, since the trailing size can be used to determined how many bytes of the last sector are owned by the file.</p>
<p>However the total size of a file is as follows:</p>
<p>(1 + number of next entries)*512 + 256 + Trailing Size (noting that trailing size is a signed number)</p>
<p>Also note that the TrailingSize member of a file entry is actually TrailingSizeNOT to get TrailingSize from TrailingSizeNOT:</p>
<p>TrailingSize = (TrailingSizeNOT + 1 in magnitude) * 2</p>
<h2>Isolating Busy Directories to get the most of LAFS</h2>
<p>One of the key features of LAFS is that it allows you to isolate busy directories of your filesystem. And further, easily cache and thus optimize access to these specific ioslated regions of your filesystem. It is thus encouraged to use long jump skip directories to isolate the root directory from other busy directories. If your directory structures are small, it may be more optimal to do the reverse (that is, isolate your less busy and potentially larger directories.) </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Jan 19 2013 05:26:25 for DarkCPU by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.2 </li>
  </ul>
</div>
</body>
</html>
