<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>NCC DarkCPU: Threading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="large.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">NCC DarkCPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_threading.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Threading </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Threading  ThreadingManager</h1>
<h2>Relavent Code Modules:</h2>
<p><a class="el" href="threading-10c_8c.html#ThreadingManager">ThreadingManager</a> <a class="el" href="mutex-10c_8c.html">Mutexes</a></p>
<h2>A Brief on The Concept of Threading in DarkCPU</h2>
<p>A thread in DarkCPU defines a single stream of execution throughout memory. The kernel will swap between these streams of execution very quickly, giving the system an illusion that multiple streams are being executed parallel to one-another. Each stream acts as if it were an individual processor on the system, each with their own ThreadContext structure, descirinbg the execution stream's state of context sinsitive data carried by the cpu such as the registers. Each thread will also have their own stack structure allocated for them as well.</p>
<p>In DarkCPU, threads are specifically just threads. They are not 'owned' by their parent process. Each process can spawn several threads, and a thread can be spawned from no particular process. Threads are commonly used in conjunction with executable images to perform the tasks described by the executable image and are thus used very frequently when developing applications or drivers for the operating system. It is important to note that a thread is not at all required for an application, and the lack of a thread running inside of an application does not make that application any less valid.</p>
<p>The threading manager keeps track of all active threads by sorting a linked list of the threads' ThreadContext strucutres (<a class="el" href="_threading.html#ThreadContextLayout">ThreadContextLayout</a>), with the root entry of this list defined in the <a class="el" href="threading-10c_8c.html#a45e8410667f75de87707e16450732ef5">threading_rootThread</a> variable. The threading manager will set <a class="el" href="threading-10c_8c.html#a65871d0022887971a1cf396049a281f9">threading_activeThread</a> to point to the active thread's ThreadContext structure. When it is time to swap threads, the threading manager will save the state of the active thread into it's respective ThreadContext structure, and walk down the linked list to the next thread. It will then proceed to put the DCPU processor into the state described by that thread's ThreadContext structure, and resume execution.</p>
<p>Each thread is also assigned a unique identification value, which is equal to the base address of their ThreadContext structure in memory.</p>
<p>If there are no registered threads in the system, the threading system will execute the threading_interrupt_idleThread routine, where it waits for a thread to execute.</p>
<p>When the thread's entrypoint returns, the thread returns to <a class="el" href="threading-10c_8c.html#ab505e6d6a7ae9aa8074163172209a81a">threading_endOfThread</a>, where it is destroyed and control is passed on to another thread.</p>
<h2>Locking the Thread Manager</h2>
<p><a class="anchor" id="LockingTheThreadManager"></a>If a given thread is performing a time-sensitive operation or if the thread is accessing a device or memory location and needs to ensure exclusive access to this resource (refer to a higher-level method of doing with with the <a class="el" href="mutex-10c_8c.html">Mutexes</a>), the threading manager can be placed into a locked state. That is, whichever thread requests a lock, will consistantly be the only thread executing on the system until it has restored the threading manager to an unlocked state. If possible, one should use a Mutex (Mutexes) to ensure synchronization of resource access, however if they are executing outside of a threaded environment or are unable to Initialize the <a class="el" href="mutex-10c_8c.html">Mutexes</a>, the threading manager can be locked.</p>
<p>The Threading Manager's State can be locked and unlocked by using the threading_lock and threading_free routines respectivley.</p>
<p>The state of the threading manager is stored inside of the threading_state variable.</p>
<h2>The Thread Environment Block</h2>
<dl class="section note"><dt>Note</dt><dd>This has not yet been implemented. The thread environment block is a structure located inside of the TreadContext strucutre. The thread environment block is pointed to by the Z register of the thread when the thread is created. It is the responsiblity of the code to maintain the Z register if it wishes to access the thread context strucutre. All functions in the DCPU kernel assumes the Z register points to the thread's ThreadContext structure when they are entered.</dd></dl>
<h2>Layout of the ThreadContext structure</h2>
<p><a class="anchor" id="ThreadContextLayout"></a></p>
<table class="doxtable">
<tr>
<th>Offset </th><th>Member Name </th><th>Description of Member</th></tr>
<tr>
<td>THREADCONTEXT_OFFSET_PC </td><td>regPc </td><td>Stores the state of the 'PC' register the last time this thread swapped from being active to inactive. </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_SP </td><td>regSp </td><td>Stores the state of the 'SP' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_EX </td><td>regEx </td><td>Stores the state of the 'EX' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_A </td><td>regA </td><td>Stores the state of the 'A' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_B </td><td>regB </td><td>Stores the state of the 'B' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_C </td><td>regC </td><td>Stores the state of the 'C' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_X </td><td>regX </td><td>Stores the state of the 'Z' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_Y </td><td>regY </td><td>Stores the state of the 'Y' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_Z </td><td>regZ </td><td>Stores the state of the 'Z' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_I </td><td>regI </td><td>Stores the state of the 'I' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_J </td><td>regJ </td><td>Stores the state of the 'J' register the last time this thread swapped from being active to inactive </td></tr>
<tr>
<td>THREADCONTEXT_OFFSET_NEXT </td><td>pNextThread </td><td>Points to the next thread in the linked list of threads, or to THREADING_INVALIDENTRY if the ThreadContext is the last in the list </td></tr>
<tr>
<td>Start of the TEB Block </td><td>N </td><td>N </td></tr>
<tr>
<td>THREADCONTEXT_TEB_OFFSET </td><td>pTeb </td><td>Points to the start of the Thread Environment Block. </td></tr>
<tr>
<td>THREADCONTEXT_TEB_OFFSET_PARENTIMAGE </td><td>pParentImage </td><td>Pointer to the executable image which this thread belongs to, or null if it does not belong to an executable </td></tr>
<tr>
<td>THREADCONTEXT_TEB_OFFSET_SEHCHAIN </td><td>pTebSehChain </td><td>Pointer to the first SEH entry in the thread's SEH chain. Refer to ExceptionManager </td></tr>
<tr>
<td>Start of the Stack Memory Region </td><td>N </td><td>N </td></tr>
<tr>
<td>... </td><td>Thread Stack </td><td>Memory allocated for the thread's stack </td></tr>
<tr>
<td>THREADCONTEXT_OFFSETEND </td><td></td><td>Offset to the last word in the ThreadContext. This is the initial value of SP for the thread. </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jan 14 2013 00:25:40 for NCC DarkCPU by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.2 </li>
  </ul>
</div>
</body>
</html>
